name: OWASP Noir Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecutar an√°lisis semanal los lunes a las 9:00 AM
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      base_url:
        description: 'URL base para el an√°lisis'
        required: false
        default: 'https://localhost:3000'

jobs:
  noir-scan:
    name: An√°lisis de Superficie de Ataque
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
      pull-requests: write
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Instalar OWASP Noir
        run: |
          # Descargar la √∫ltima versi√≥n de Noir
          LATEST_VERSION=$(curl -s https://api.github.com/repos/owasp-noir/noir/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "Instalando OWASP Noir versi√≥n: $LATEST_VERSION"
          
          wget -q "https://github.com/owasp-noir/noir/releases/download/${LATEST_VERSION}/noir-${LATEST_VERSION}-x86_64-unknown-linux-gnu.tar.gz"
          tar -xzf "noir-${LATEST_VERSION}-x86_64-unknown-linux-gnu.tar.gz"
          chmod +x noir
          sudo mv noir /usr/local/bin/
          
          # Verificar instalaci√≥n
          noir --version
      
      - name: Ejecutar an√°lisis de seguridad
        id: noir-scan
        run: |
          BASE_URL="${{ github.event.inputs.base_url || 'https://localhost:3000' }}"
          
          echo "Ejecutando an√°lisis con URL base: $BASE_URL"
          
          # Crear directorio para reportes
          mkdir -p security-reports
          
          # Ejecutar Noir con tags para detectar vulnerabilidades
          noir -b . -u "$BASE_URL" -f json -T > security-reports/noir-report.json
          
          # Tambi√©n generar reporte en formato OAS (OpenAPI Specification)
          noir -b . -u "$BASE_URL" -f oas3 > security-reports/openapi-spec.json
          
          echo "‚úì An√°lisis completado"
      
      - name: Analizar resultados
        id: analyze
        run: |
          # Contar endpoints y vulnerabilidades
          ENDPOINTS=$(jq '.endpoints | length' security-reports/noir-report.json)
          VULNERABILITIES=$(jq '[.endpoints[].params[].tags[]] | length' security-reports/noir-report.json)
          
          echo "endpoints=$ENDPOINTS" >> $GITHUB_OUTPUT
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
          
          echo "üìä Endpoints detectados: $ENDPOINTS"
          echo "‚ö†Ô∏è  Vulnerabilidades potenciales: $VULNERABILITIES"
          
          # Crear resumen
          echo "## üîç Resumen del An√°lisis OWASP Noir" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Endpoints detectados:** $ENDPOINTS" >> $GITHUB_STEP_SUMMARY
          echo "- **Vulnerabilidades potenciales:** $VULNERABILITIES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Listar endpoints cr√≠ticos
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "### ‚ö†Ô∏è Endpoints con Vulnerabilidades Potenciales" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            jq -r '.endpoints[] | select(.params[].tags | length > 0) | "- **[\(.method)]** \(.url) - \(.params[].tags[].name // "unknown")"' security-reports/noir-report.json >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Comentar en PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('security-reports/noir-report.json', 'utf8'));
            
            const endpoints = report.endpoints.length;
            const vulnerabilities = report.endpoints.reduce((acc, ep) => {
              return acc + ep.params.reduce((pAcc, param) => {
                return pAcc + (param.tags ? param.tags.length : 0);
              }, 0);
            }, 0);
            
            let comment = `## üîç An√°lisis de Seguridad OWASP Noir\n\n`;
            comment += `- **Endpoints detectados:** ${endpoints}\n`;
            comment += `- **Vulnerabilidades potenciales:** ${vulnerabilities}\n\n`;
            
            if (vulnerabilities > 0) {
              comment += `### ‚ö†Ô∏è Atenci√≥n Requerida\n\n`;
              comment += `Se detectaron ${vulnerabilities} vulnerabilidades potenciales. `;
              comment += `Revisa los reportes de seguridad antes de hacer merge.\n\n`;
              
              // Listar primeras 5 vulnerabilidades
              const vulnEndpoints = report.endpoints.filter(ep => 
                ep.params.some(p => p.tags && p.tags.length > 0)
              ).slice(0, 5);
              
              if (vulnEndpoints.length > 0) {
                comment += `#### Ejemplos:\n\n`;
                vulnEndpoints.forEach(ep => {
                  comment += `- **[${ep.method}]** \`${ep.url}\`\n`;
                  ep.params.forEach(param => {
                    if (param.tags && param.tags.length > 0) {
                      param.tags.forEach(tag => {
                        comment += `  - ‚ö†Ô∏è **${tag.name}**: ${tag.description}\n`;
                      });
                    }
                  });
                });
              }
            } else {
              comment += `‚úÖ No se detectaron vulnerabilidades obvias en este an√°lisis.\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Subir reportes como artefactos
        uses: actions/upload-artifact@v4
        with:
          name: noir-security-reports
          path: security-reports/
          retention-days: 90
      
      - name: Verificar umbral de vulnerabilidades
        if: always()
        run: |
          VULNERABILITIES=${{ steps.analyze.outputs.vulnerabilities }}
          MAX_VULNERABILITIES=10
          
          if [ "$VULNERABILITIES" -gt "$MAX_VULNERABILITIES" ]; then
            echo "‚ùå Se detectaron $VULNERABILITIES vulnerabilidades potenciales (m√°ximo permitido: $MAX_VULNERABILITIES)"
            echo "Por favor, revisa y corrige las vulnerabilidades antes de continuar"
            exit 1
          else
            echo "‚úÖ N√∫mero de vulnerabilidades dentro del umbral aceptable"
          fi
